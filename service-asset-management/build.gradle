description = 'SiteWhere Asset Management Microservice'

dependencies {
	compile project(':sitewhere-core')
	compile project(':sitewhere-mongodb')
	compile project(':sitewhere-microservice')
	compile project(':sitewhere-grpc-client')
	compile project(':service-batch-operations')
	compile project(':service-command-delivery')
	compile project(':service-device-management')
	compile project(':service-device-registration')
	compile project(':service-device-state')
	compile project(':service-event-management')
	compile project(':service-event-search')
	compile project(':service-event-sources')
	compile project(':service-inbound-processing')
	compile project(':service-instance-management')
	compile project(':service-label-generation')
	compile project(':service-outbound-connectors')
	compile project(':service-schedule-management')
	compile project(':service-streaming-media')
	
	// REST template for SCIM access.
    compile group: 'org.springframework', name: 'spring-web'
    compile group: 'org.apache.httpcomponents', name: 'httpclient'
	
	// WSO2 dependencies.
    compile group: 'com.google.code.ksoap2-android', name: 'ksoap2-android', version:'3.4.0'
    compile group: 'com.google.code.ksoap2-android', name: 'ksoap2-j2se', version:'3.4.0'
    compile group: 'com.google.code.ksoap2-android', name: 'ksoap2-extras', version:'3.4.0'
}

license {
	exclude "**/modules/wso2/**"
}

apply plugin: 'org.springframework.boot'
springBoot {
    mainClassName = 'com.sitewhere.asset.AssetManagementApplication'
}

// Keep original jar.
jar {
	enabled = true
}

// Reclassify Spring Boot jar.
bootJar {
	classifier = 'boot'
}

// Only publish thin jar.
apply plugin: 'maven-publish'
publishing {
	publications {
        mavenJava(MavenPublication) {
            from components.java
        }
	}
}

// Create a Dockerfile.
task dockerFile(type: com.bmuschko.gradle.docker.tasks.image.Dockerfile, dependsOn: bootJar) {
    destFile = project.file('build/docker/Dockerfile')
    from "${rootProject.ext['docker.base.image']}"
	instruction "LABEL maintainer=${rootProject.ext['docker.maintainer']}"
	
	instruction "RUN wget -qO/bin/grpc_health_probe https://github.com/grpc-ecosystem/grpc-health-probe/releases/download/v0.2.2/grpc_health_probe-linux-amd64 && chmod +x /bin/grpc_health_probe"
		
	// Copy Spring Boot jar.
	copyFile("${project.name}-${project.version}-boot.jar", "/")
			
	if(!project.hasProperty("debug")) {
		defaultCommand 'java', '-server', '-Xmx512M', '-Xss384K', '-jar', "/${project.name}-${project.version}-boot.jar"	
	} else {
		println "Generating DEBUG IMAGE for project ${project.name}"

		def jdwpPort = 8006
		def jmxPort = 1106
		
		// Expose ports.
		exposePort jdwpPort
		exposePort jmxPort

		defaultCommand 'java', '-server', '-Xdebug', '-Dcom.sun.management.jmxremote.local.only=false', '-Dcom.sun.management.jmxremote.ssl=false', '-Dcom.sun.management.jmxremote.authenticate=false', "-Dcom.sun.management.jmxremote.port=${jmxPort}", "-Dcom.sun.management.jmxremote.rmi.port=${jmxPort}", '-Dcom.sun.management.jmxremote.host=0.0.0.0', '-Djava.rmi.server.hostname=0.0.0.0', "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=${jdwpPort}", '-Xmx512M', '-Xss384K', '-jar', "/${project.name}-${project.version}-boot.jar"
	}
}

// Copy artifact to Docker input folder.
task copyArtifactsToDocker(type: Copy, dependsOn: dockerFile) {
    from "${buildDir}/libs/${project.name}-${project.version}-boot.jar"
    into 'build/docker'
}

// Build an image from the Dockerfile.
task dockerImage(type: com.bmuschko.gradle.docker.tasks.image.DockerBuildImage, dependsOn: copyArtifactsToDocker) {
    inputDir = project.file('build/docker')
	if(!project.hasProperty("debug")) {
	    tags = ["${dockerRepository}/sitewhere/${project.name}:${version}"]
	} else {
	    tags = ["${dockerRepository}/sitewhere/${project.name}:debug-${version}"]		
	}
}

// Build an image from the Dockerfile with tag latest.
task dockerImageLatest(type: com.bmuschko.gradle.docker.tasks.image.DockerBuildImage, dependsOn: copyArtifactsToDocker) {
    inputDir = project.file('build/docker')
	
	def primaryTag = ""
	def secondaryTag = ""

	if(!project.hasProperty("debug")) {
		primaryTag = "${dockerRepository}/sitewhere/${project.name}:${version}"
		secondaryTag = "${dockerRepository}/sitewhere/${project.name}:latest"
	} else {
		primaryTag = "${dockerRepository}/sitewhere/${project.name}:debug-${version}"
		secondaryTag = "${dockerRepository}/sitewhere/${project.name}:debug-latest"
	}
	tags = [primaryTag, secondaryTag]
}

// Build an image from the Dockerfile with tag edge.
task dockerImageEdge(type: com.bmuschko.gradle.docker.tasks.image.DockerBuildImage, dependsOn: copyArtifactsToDocker) {
    inputDir = project.file('build/docker')
	
	def primaryTag = ""
	def secondaryTag = ""

	if(!project.hasProperty("debug")) {
		primaryTag = "${dockerRepository}/sitewhere/${project.name}:${version}"
	} else {
		primaryTag = "${dockerRepository}/sitewhere/${project.name}:debug-${version}"
	}
	secondaryTag = "${dockerRepository}/sitewhere/${project.name}:edge"
	tags = [primaryTag, secondaryTag]
}

// Push image to remote repository.
task dockerPush(type: com.bmuschko.gradle.docker.tasks.image.DockerPushImage, dependsOn: dockerImage) {
    imageName = "${dockerRepository}/sitewhere/${project.name}".toString()
    tag = "${version}".toString()
}

// Push image to remote repository.
task dockerPushLatest(type: com.bmuschko.gradle.docker.tasks.image.DockerPushImage, dependsOn: dockerImageLatest) {
    imageName = "${dockerRepository}/sitewhere/${project.name}".toString()
}

// Push image to remote repository.
task dockerPushEdge(type: com.bmuschko.gradle.docker.tasks.image.DockerPushImage, dependsOn: dockerImageEdge) {
    imageName = "${dockerRepository}/sitewhere/${project.name}".toString()
}
